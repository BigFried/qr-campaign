<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BigFried QR</title>
  <style>
    html, body { margin:0; width:100%; height:100%; overflow:hidden; }
    img { width:100vw; height:100vh; object-fit:cover; display:block; }
    .overlay{
      position:fixed; inset:0;
      display:flex; flex-direction:column; justify-content:flex-end; align-items:center;
      padding:24px; color:#fff; font-family:system-ui, Arial;
      background:linear-gradient(transparent, rgba(0,0,0,.65));
      text-align:center;
    }
    .serial{
      font-size:18px; font-weight:800;
      background:rgba(0,0,0,.45);
      padding:10px 14px; border-radius:12px; margin-top:10px;
    }
  </style>
</head>
<body>

<img id="resultImage" alt="result" />
<div class="overlay" id="overlay" style="display:none"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, runTransaction, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // âœ… Firebase config Ø¨ØªØ§Ø¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyAnE3HIxB7Vw5s8Z50RKYJbfchZfNdPfvI",
    authDomain: "bigfried-qr.firebaseapp.com",
    databaseURL: "https://bigfried-qr-default-rtdb.firebaseio.com",
    projectId: "bigfried-qr",
    storageBucket: "bigfried-qr.firebasestorage.app",
    messagingSenderId: "312013376338",
    appId: "1:312013376338:web:66f318f9ed89718b4bc88b",
    measurementId: "G-LY132NMZ0X"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // âœ… ØµÙˆØ±Ùƒ
  const IMG_10     = "../images/10.png";
  const IMG_15     = "../images/15.png";
  const IMG_25     = "../images/25.png";
  const IMG_50     = "../images/50.png";
  const IMG_COMBO  = "../images/combo.png";
  const IMG_LUCK   = "../images/goodLuck.png";

  // âœ… Ø§Ø®ØªÙŠØ§Ø± Ù†ØªÙŠØ¬Ø© Ø¹Ø§Ø¯ÙŠØ© + Ù†Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„ØµÙˆØ±Ø© (Ø¹Ø´Ø§Ù† Ù†Ø¯ÙŠÙ‡Ø§ Serial)
  function pickNormalReward() {
    const pool = [
      // 10% ÙƒØªÙŠØ± Ø¬Ø¯Ø§Ù‹
      { type: "10", img: IMG_10 }, { type: "10", img: IMG_10 }, { type: "10", img: IMG_10 },
      { type: "10", img: IMG_10 }, { type: "10", img: IMG_10 }, { type: "10", img: IMG_10 },
      { type: "10", img: IMG_10 },

      // Combo ÙƒØªÙŠØ±
      { type: "combo", img: IMG_COMBO }, { type: "combo", img: IMG_COMBO }, { type: "combo", img: IMG_COMBO },
      { type: "combo", img: IMG_COMBO }, { type: "combo", img: IMG_COMBO },

      // GoodLuck Ù…ØªÙˆØ³Ø· (Ù†Ø¹ØªØ¨Ø±Ù‡ "luck" Ø¹Ø§Ø¯ÙŠ ÙˆÙ„Ù‡ Serial Ø¨Ø±Ø¶Ùˆ)
      { type: "luck", img: IMG_LUCK }, { type: "luck", img: IMG_LUCK }, { type: "luck", img: IMG_LUCK },

      // 15% Ù‚Ù„ÙŠÙ„
      { type: "15", img: IMG_15 }, { type: "15", img: IMG_15 },

      // 25% Ù†Ø§Ø¯Ø±
      { type: "25", img: IMG_25 }
    ];

    return pool[Math.floor(Math.random() * pool.length)];
  }

  // âœ… Prefix Ù„ÙƒÙ„ Ù†ÙˆØ¹
  function prefixOf(type) {
    switch (type) {
      case "50": return "BIG50";
      case "25": return "BIG25";
      case "15": return "BIG15";
      case "10": return "BIG10";
      case "combo": return "BIGCOMBO";
      case "luck": return "BIGLUCK";
      default: return "BIG";
    }
  }

  // âœ… Serial Ø¹Ø§Ù… (Ù…Ø´ 50 Ø¨Ø³)
  function makeSerial(prefix, seq) {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const rand = Math.floor(1000 + Math.random() * 9000);
    return `${prefix}-${y}${m}${day}-${String(seq).padStart(5,'0')}-${rand}`;
  }

  // âœ… ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ Scan ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© + Serial
  const campaignRef = ref(db, "campaign");

  const tx = await runTransaction(campaignRef, (data) => {
    if (!data) {
      data = { scanCount: 0, sinceLast50: 0, serialSeq: 0 };
    }

    data.scanCount = (data.scanCount || 0) + 1;
    data.sinceLast50 = (data.sinceLast50 || 0) + 1;

    const n = data.sinceLast50;

    // âœ… Probability Ramp Ù„Ù„Ù€ 50%
    let p = 0;
    if (n <= 10) p = 0;
    else if (n <= 20) p = 0.02;
    else if (n <= 30) p = 0.05;
    else if (n <= 40) p = 0.12;
    else if (n <= 50) p = 0.25;
    else p = 1;

    const win50 = Math.random() < p;

    // âœ… Ù†Ø®ØªØ§Ø± Ø§Ù„Ù†ÙˆØ¹
    let rewardType = "normal";
    if (win50) {
      rewardType = "50";
      data.sinceLast50 = 0; // Reset
    } else {
      // Ù†ØªÙŠØ¬Ø© Ø¹Ø§Ø¯ÙŠØ©: Ø§Ø®ØªØ§Ø± Ù†ÙˆØ¹ Ø¹Ø§Ø¯ÙŠ (Ù‡Ù†Ø®ØªØ§Ø±Ù‡ Ø¨Ø±Ù‘Ù‡ transaction Ø¨Ø±Ø¶Ùˆ)
      // Ù‡Ù†Ø§ Ù‡Ù†Ø­Ø· marker Ø¨Ø³
      rewardType = "normal";
    }

    // âœ… Ø²ÙˆÙ‘Ø¯ serialSeq Ø¯Ø§Ø¦Ù…Ù‹Ø§ (Ø¹Ù„Ø´Ø§Ù† Ø£ÙŠ Ù†ØªÙŠØ¬Ø© Ù„ÙŠÙ‡Ø§ Serial)
    data.serialSeq = (data.serialSeq || 0) + 1;

    data.lastWinner = {
      type: rewardType,      // "50" Ø£Ùˆ "normal"
      serialSeq: data.serialSeq,
      at: new Date().toISOString()
    };

    return data;
  });

  const result = tx.snapshot.val();
  const lastWinner = result?.lastWinner;

  const imgEl = document.getElementById("resultImage");
  const overlay = document.getElementById("overlay");

  // âœ… Ù†Ø­Ø¯Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø¨Ø¹Ø¯ Ø§Ù„Ù€ transaction
  let finalType, finalImg;

  if (lastWinner?.type === "50") {
    finalType = "50";
    finalImg = IMG_50;
  } else {
    const normal = pickNormalReward();
    finalType = normal.type;     // 10 / 15 / 25 / combo / luck
    finalImg = normal.img;
  }

  // âœ… Ù†ÙˆÙ„Ù‘Ø¯ Serial Ø­Ø³Ø¨ Ø§Ù„Ù†ÙˆØ¹ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… seq Ø§Ù„Ù„ÙŠ Ø§ØªØ³Ø¬Ù„ ÙÙŠ transaction
  const serial = makeSerial(prefixOf(finalType), lastWinner.serialSeq);

  // âœ… Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±Ø© + Overlay + Serial (Ù„ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹)
  imgEl.src = finalImg;
  overlay.style.display = "flex";

  const title =
    finalType === "50"   ? "Ù…Ø¨Ø±ÙˆÙˆÙˆÙˆÙƒ! Ø®ØµÙ… 50% ğŸ‰" :
    finalType === "25"   ? "Ù…Ø¨Ø±ÙˆÙƒ! Ø®ØµÙ… 25% ğŸ‰" :
    finalType === "15"   ? "Ù…Ø¨Ø±ÙˆÙƒ! Ø®ØµÙ… 15% ğŸ‰" :
    finalType === "10"   ? "Ù…Ø¨Ø±ÙˆÙƒ! Ø®ØµÙ… 10% ğŸ‰" :
    finalType === "combo"? "Ù…Ø¨Ø±ÙˆÙƒ! COMBO ğŸ‰" :
    "Ø­Ø¸ Ø³Ø¹ÙŠØ¯ ğŸ‰";

  overlay.innerHTML = `
    <div>
      <div style="font-size:22px;font-weight:900">${title}</div>
      <div class="serial">Serial: ${serial}</div>
      <div style="margin-top:10px;font-size:14px;opacity:.9">ØµÙˆÙ‘Ø± Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ±ÙˆÙ‘Ø­ Ø¨ÙŠÙ‡Ø§ Ù„Ù„ÙØ±Ø¹.</div>
    </div>
  `;

  // âœ… Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ ÙÙŠ Firebase (Ù„ÙƒÙ„ Ø§Ù„Ø£Ù†ÙˆØ§Ø¹)
  await set(ref(db, `campaign/winners/${serial}`), {
    createdAt: lastWinner.at,
    redeemed: false,
    type: finalType
  });

</script>

</body>
</html>
