<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BigFried QR</title>
  <style>
    html, body { margin:0; width:100%; height:100%; overflow:hidden; }
    img { width:100vw; height:100vh; object-fit:cover; display:block; }
    .overlay{
      position:fixed; inset:0;
      display:flex; flex-direction:column; justify-content:flex-end; align-items:center;
      padding:24px; color:#fff; font-family:system-ui, Arial;
      background:linear-gradient(transparent, rgba(0,0,0,.65));
      text-align:center;
    }
    .serial{
      font-size:18px; font-weight:800;
      background:rgba(0,0,0,.45);
      padding:10px 14px; border-radius:12px; margin-top:10px;
    }
  </style>
</head>
<body>

<img id="resultImage" alt="result" />
<div class="overlay" id="overlay" style="display:none"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, runTransaction, set } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  // âœ… Ù†ÙØ³ config Ø¨ØªØ§Ø¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyAnE3HIxB7Vw5s8Z50RKYJbfchZfNdPfvI",
    authDomain: "bigfried-qr.firebaseapp.com",
    databaseURL: "https://bigfried-qr-default-rtdb.firebaseio.com",
    projectId: "bigfried-qr",
    storageBucket: "bigfried-qr.firebasestorage.app",
    messagingSenderId: "312013376338",
    appId: "1:312013376338:web:66f318f9ed89718b4bc88b",
    measurementId: "G-LY132NMZ0X"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  // âœ… ØµÙˆØ±Ùƒ
  const IMG_10  = "../images/10.png";
  const IMG_15  = "../images/15.png";
  const IMG_25  = "../images/25.png";
  const IMG_50  = "../images/50.png";
  const IMG_COMBO = "../images/combo.png";
  const IMG_LUCK  = "../images/goodLuck.png";

  // âœ… Ø§Ø®ØªÙŠØ§Ø± Ù†ØªÙŠØ¬Ø© Ø¹Ø§Ø¯ÙŠØ© (Ø¨Ø¯ÙˆÙ† 50%)
  function pickNormalReward() {
    const pool = [
      IMG_10, IMG_10, IMG_10,
      IMG_15, IMG_15,
      IMG_25,
      IMG_COMBO,
      IMG_LUCK, IMG_LUCK, IMG_LUCK
    ];
    return pool[Math.floor(Math.random() * pool.length)];
  }

  // âœ… Serial
  function makeSerial(seq) {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const rand = Math.floor(1000 + Math.random() * 9000);
    return `BIG50-${y}${m}${day}-${String(seq).padStart(5,'0')}-${rand}`;
  }

  // âœ… Ù‡Ù†Ø§ Ø¨Ù†Ø³Ø¬Ù„ ÙƒÙ„ Scan ÙˆÙ†Ù‚Ø±Ø± 50% ÙˆÙ„Ø§ Ù„Ø§
  const campaignRef = ref(db, "campaign");

  const tx = await runTransaction(campaignRef, (data) => {
    if (!data) {
      data = { scanCount: 0, sinceLast50: 0, serialSeq: 0 };
    }

    // Ø²ÙˆÙ‘Ø¯ Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ÙƒØ§Ù†Ø§Øª
    data.scanCount = (data.scanCount || 0) + 1;

    // Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø³ÙƒØ§Ù†Ø§Øª Ù…Ù† Ø¢Ø®Ø± Ù…Ø±Ø© 50%
    data.sinceLast50 = (data.sinceLast50 || 0) + 1;

    const n = data.sinceLast50;

    // âœ… Probability Ramp (50% Ù†Ø§Ø¯Ø± Ø¨Ø³ Ù…ÙˆØ¬ÙˆØ¯)
    let p = 0;
    if (n <= 10) p = 0;
    else if (n <= 20) p = 0.02;
    else if (n <= 30) p = 0.05;
    else if (n <= 40) p = 0.12;
    else if (n <= 50) p = 0.25;
    else p = 1; // Ø¨Ø¹Ø¯ 50 Ø§Ø³ÙƒØ§Ù†: Ù„Ø§Ø²Ù… ÙŠØ·Ù„Ø¹

    const win50 = Math.random() < p;

    if (win50) {
      data.serialSeq = (data.serialSeq || 0) + 1;
      const serial = makeSerial(data.serialSeq);

      data.lastWinner = { type: "50", serial, at: new Date().toISOString() };
      data.sinceLast50 = 0; // Reset Ø§Ù„Ø¯ÙˆØ±Ø©
    } else {
      data.lastWinner = { type: "normal" };
    }

    return data;
  });

  const result = tx.snapshot.val();
  const lastWinner = result?.lastWinner;

  const imgEl = document.getElementById("resultImage");
  const overlay = document.getElementById("overlay");

  if (lastWinner?.type === "50") {
    imgEl.src = IMG_50;
    overlay.style.display = "flex";
    overlay.innerHTML = `
      <div>
        <div style="font-size:22px;font-weight:900">Ù…Ø¨Ø±ÙˆÙˆÙˆÙˆÙƒ! Ø®ØµÙ… 50% ğŸ‰</div>
        <div class="serial">Serial: ${lastWinner.serial}</div>
        <div style="margin-top:10px;font-size:14px;opacity:.9">ØµÙˆÙ‘Ø± Ø§Ù„Ø´Ø§Ø´Ø© ÙˆØ±ÙˆÙ‘Ø­ Ø¨ÙŠÙ‡Ø§ Ù„Ù„ÙØ±Ø¹.</div>
      </div>
    `;

    // Ø³Ø¬Ù„ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await set(ref(db, `campaign/winners/${lastWinner.serial}`), {
      createdAt: lastWinner.at,
      redeemed: false
    });

  } else {
    imgEl.src = pickNormalReward();
  }
</script>

</body>
</html>
