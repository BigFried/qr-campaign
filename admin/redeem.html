<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>BigFried | Redeem</title>
  <style>
    :root{
      --bg:#0b0f14;
      --card:#121826;
      --muted:#8aa0b6;
      --text:#e9f2ff;
      --ok:#18c964;
      --bad:#ff4d4f;
      --warn:#f5a524;
      --line: rgba(255,255,255,.08);
      --btn:#e60000;
      --btn2:#1b2638;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background: radial-gradient(1200px 600px at 20% 0%, rgba(230,0,0,.22), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(24,201,100,.14), transparent 55%),
                  var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .wrap{width:100%; max-width:560px}
    .brand{
      display:flex; align-items:center; justify-content:space-between;
      margin-bottom:14px;
    }
    .brand .title{
      display:flex; flex-direction:column; gap:4px;
    }
    .brand h1{
      margin:0;
      font-size:20px;
      letter-spacing:.2px;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      font-size:13px;
    }
    .badge{
      padding:8px 10px;
      border:1px solid var(--line);
      border-radius:12px;
      color:var(--muted);
      font-size:12px;
      background:rgba(255,255,255,.03);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      backdrop-filter: blur(8px);
    }
    .field{
      margin-top:10px;
      display:flex;
      gap:10px;
      flex-direction:column;
    }
    label{font-size:13px; color:var(--muted)}
    .inputRow{
      display:flex; gap:10px;
    }
    input{
      flex:1;
      padding:14px 14px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      outline:none;
      font-size:16px;
      letter-spacing:.2px;
    }
    input::placeholder{color:rgba(138,160,182,.65)}
    .btn{
      border:none;
      border-radius:14px;
      padding:14px 16px;
      cursor:pointer;
      font-weight:800;
      font-size:15px;
      transition:transform .05s ease, opacity .2s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
      user-select:none;
      white-space:nowrap;
    }
    .btn:active{transform:scale(.99)}
    .btnPrimary{background:var(--btn); color:#fff;}
    .btnSecondary{background:var(--btn2); color:var(--text); border:1px solid var(--line);}
    .btnGhost{background:transparent; color:var(--muted); border:1px dashed var(--line);}
    .row{
      display:flex;
      gap:10px;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .row .btn{flex:1}
    .status{
      margin-top:14px;
      border-radius:16px;
      border:1px solid var(--line);
      padding:14px;
      background:rgba(255,255,255,.03);
      display:none;
    }
    .statusHeader{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px;
      margin-bottom:8px;
    }
    .pill{
      padding:6px 10px;
      border-radius:999px;
      font-size:12px;
      font-weight:800;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--muted);
    }
    .pill.ok{color:var(--ok); border-color:rgba(24,201,100,.25); background:rgba(24,201,100,.08);}
    .pill.bad{color:var(--bad); border-color:rgba(255,77,79,.25); background:rgba(255,77,79,.08);}
    .pill.warn{color:var(--warn); border-color:rgba(245,165,36,.25); background:rgba(245,165,36,.10);}
    .kv{
      display:grid;
      grid-template-columns: 120px 1fr;
      gap:8px 10px;
      font-size:14px;
      margin-top:10px;
    }
    .k{color:var(--muted)}
    .v{color:var(--text); word-break:break-word}
    .small{color:var(--muted); font-size:12px; margin-top:10px; line-height:1.5}
    .typeTag{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      font-size:12px;
      color:var(--muted);
      margin-top:8px;
    }
    .toast{
      position:fixed;
      bottom:18px;
      left:18px;
      right:18px;
      max-width:560px;
      margin:auto;
      background:rgba(0,0,0,.75);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      padding:12px 14px;
      display:none;
      font-size:13px;
    }
  </style>
</head>
<body>

<div class="wrap">
  <div class="brand">
    <div class="title">
      <h1>BigFried â€” ØµÙØ­Ø© ØµØ±Ù Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„</h1>
      <p>Ø§ÙƒØªØ¨ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ â†’ ØªØ­Ù‚Ù‚ â†’ Ù„Ùˆ ØµØ§Ù„Ø­ Ø§Ø¶ØºØ· â€œØªÙ… Ø§Ù„ØµØ±Ùâ€</p>
    </div>
    <div class="badge">Admin</div>
  </div>

  <div class="card">
    <div class="field">
      <label>Serial</label>
      <div class="inputRow">
        <input id="serial" placeholder="Ù…Ø«Ø§Ù„: BIG50-20251216-00001-1234" autocomplete="off" />
      </div>
      <div class="row">
        <button class="btn btnPrimary" id="checkBtn">ğŸ” ØªØ­Ù‚Ù‚</button>
        <button class="btn btnSecondary" id="redeemBtn" style="display:none;">âœ… ØªÙ… Ø§Ù„ØµØ±Ù</button>
        <button class="btn btnGhost" id="copyBtn" style="display:none;">ğŸ“‹ Ù†Ø³Ø®</button>
      </div>
      <div class="small">
        * Ù„Ùˆ Ø·Ù„Ø¹ â€œÙ…Ø³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ ÙƒØ¯Ù‡â€ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ Ø§ØªØµØ±Ù Ø®Ù„Ø§Øµ.<br>
        * Ù„Ùˆ â€œÙ…Ø´ Ù…ÙˆØ¬ÙˆØ¯â€ ÙŠØ¨Ù‚Ù‰ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ ØºÙ„Ø· Ø£Ùˆ Ù…ØªØ²ÙˆÙ‘Ø±.
      </div>
    </div>

    <div class="status" id="statusBox">
      <div class="statusHeader">
        <div>
          <div style="font-weight:900;font-size:16px" id="statusTitle">â€”</div>
          <div class="typeTag" id="typeTag" style="display:none;">ğŸ·ï¸ <span id="typeText"></span></div>
        </div>
        <div class="pill" id="statusPill">â€”</div>
      </div>

      <div class="kv">
        <div class="k">Serial</div><div class="v" id="vSerial">â€”</div>
        <div class="k">Created</div><div class="v" id="vCreated">â€”</div>
        <div class="k">Redeemed</div><div class="v" id="vRedeemed">â€”</div>
        <div class="k">RedeemedAt</div><div class="v" id="vRedeemedAt">â€”</div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAnE3HIxB7Vw5s8Z50RKYJbfchZfNdPfvI",
    authDomain: "bigfried-qr.firebaseapp.com",
    databaseURL: "https://bigfried-qr-default-rtdb.firebaseio.com",
    projectId: "bigfried-qr",
    storageBucket: "bigfried-qr.firebasestorage.app",
    messagingSenderId: "312013376338",
    appId: "1:312013376338:web:66f318f9ed89718b4bc88b",
    measurementId: "G-LY132NMZ0X"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getDatabase(app);

  const serialInput = document.getElementById("serial");
  const checkBtn = document.getElementById("checkBtn");
  const redeemBtn = document.getElementById("redeemBtn");
  const copyBtn = document.getElementById("copyBtn");

  const statusBox = document.getElementById("statusBox");
  const statusTitle = document.getElementById("statusTitle");
  const statusPill = document.getElementById("statusPill");
  const typeTag = document.getElementById("typeTag");
  const typeText = document.getElementById("typeText");

  const vSerial = document.getElementById("vSerial");
  const vCreated = document.getElementById("vCreated");
  const vRedeemed = document.getElementById("vRedeemed");
  const vRedeemedAt = document.getElementById("vRedeemedAt");

  const toast = document.getElementById("toast");

  let currentSerial = null;
  let currentData = null;

  function showToast(msg){
    toast.textContent = msg;
    toast.style.display = "block";
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=> toast.style.display="none", 1600);
  }

  function showStatus({title, pillText, pillClass, serial, createdAt, redeemed, redeemedAt, type}){
    statusBox.style.display = "block";
    statusTitle.textContent = title;

    statusPill.className = "pill " + (pillClass || "");
    statusPill.textContent = pillText;

    vSerial.textContent = serial || "â€”";
    vCreated.textContent = createdAt || "â€”";
    vRedeemed.textContent = redeemed ? "Yes" : "No";
    vRedeemedAt.textContent = redeemedAt || "â€”";

    if (type) {
      typeTag.style.display = "inline-flex";
      typeText.textContent = type;
    } else {
      typeTag.style.display = "none";
    }
  }

  function normalizeType(type){
    if (!type) return "unknown";
    if (type === "combo") return "COMBO";
    if (type === "luck") return "LUCK";
    if (type === "10") return "10%";
    if (type === "15") return "15%";
    if (type === "25") return "25%";
    if (type === "50") return "50%";
    return String(type);
  }

  async function checkSerial() {
    const serial = serialInput.value.trim();
    redeemBtn.style.display = "none";
    copyBtn.style.display = "none";
    currentSerial = null;
    currentData = null;

    if (!serial) {
      showStatus({
        title: "Ø§ÙƒØªØ¨ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ Ø§Ù„Ø£ÙˆÙ„",
        pillText: "Missing",
        pillClass: "warn",
        serial: "",
        createdAt: "",
        redeemed: false,
        redeemedAt: "",
        type: ""
      });
      return;
    }

    const winnerRef = ref(db, `campaign/winners/${serial}`);
    const snap = await get(winnerRef);

    if (!snap.exists()) {
      showStatus({
        title: "Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ âŒ",
        pillText: "Not Found",
        pillClass: "bad",
        serial,
        createdAt: "",
        redeemed: false,
        redeemedAt: "",
        type: ""
      });
      return;
    }

    const data = snap.val();
    currentSerial = serial;
    currentData = data;

    const type = normalizeType(data.type);
    const createdAt = data.createdAt || "";
    const redeemed = data.redeemed === true;

    copyBtn.style.display = "inline-flex";

    if (redeemed) {
      showStatus({
        title: "Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ âŒ",
        pillText: "Redeemed",
        pillClass: "bad",
        serial,
        createdAt,
        redeemed: true,
        redeemedAt: data.redeemedAt || "-",
        type
      });
      return;
    }

    showStatus({
      title: "ØµØ§Ù„Ø­ ÙˆÙ„Ø³Ù‡ Ù…Ø§ Ø§ØªØµØ±ÙØ´ âœ…",
      pillText: "Valid",
      pillClass: "ok",
      serial,
      createdAt,
      redeemed: false,
      redeemedAt: "",
      type
    });

    redeemBtn.style.display = "inline-flex";
  }

  async function redeemSerial() {
    if (!currentSerial) return;

    const winnerRef = ref(db, `campaign/winners/${currentSerial}`);
    await update(winnerRef, {
      redeemed: true,
      redeemedAt: new Date().toISOString()
    });

    redeemBtn.style.display = "none";

    showStatus({
      title: "ØªÙ… Ø§Ù„ØµØ±Ù ÙˆØ§ØªÙ‚ÙÙ„ Ø§Ù„Ø³ÙŠØ±ÙŠØ§Ù„ âœ…",
      pillText: "Redeemed Now",
      pillClass: "ok",
      serial: currentSerial,
      createdAt: currentData?.createdAt || "",
      redeemed: true,
      redeemedAt: new Date().toISOString(),
      type: normalizeType(currentData?.type)
    });

    showToast("ØªÙ… Ø§Ù„ØµØ±Ù âœ…");
  }

  async function copySerial(){
    const serial = serialInput.value.trim();
    if (!serial) return;
    try{
      await navigator.clipboard.writeText(serial);
      showToast("Ø§ØªÙ†Ø³Ø® âœ…");
    }catch{
      showToast("Ù…Ø´ Ù‚Ø§Ø¯Ø± Ø£Ù†Ø³Ø® Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¯Ù‡");
    }
  }

  checkBtn.addEventListener("click", checkSerial);
  redeemBtn.addEventListener("click", redeemSerial);
  copyBtn.addEventListener("click", copySerial);

  // Enter key = ØªØ­Ù‚Ù‚
  serialInput.addEventListener("keydown", (e)=>{
    if(e.key === "Enter") checkSerial();
  });
</script>

</body>
</html>

